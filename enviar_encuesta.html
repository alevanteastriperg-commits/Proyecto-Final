<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Enviar Encuesta</title>
  <link rel="stylesheet" href="estilos.css">

  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <script>
    emailjs.init("EvC3ct126HsxXo170"); 
  </script>
</head>
<body>

<header>Enviar Encuesta – La Miguelina</header>

<div class="container">
  <nav><a href="index.html">Inicio</a></nav>

  <div class="card">
    <h3>Correos registrados</h3>
    <div id="list"></div>
  </div>

  <div class="card">
    <h3>Generar y Enviar Encuestas</h3>
    <button onclick="generar()">Enviar encuesta a todos</button>
    <div id="links"></div>
    <p id="msg"></p>
  </div>

</div>

<script src="app.js"></script>

<script>
const SERVICE_ID = "service_rkz5oss";
const TEMPLATE_ID = "template_7i4grkk";

let clientes = get(KEY_CLIENTES);

document.getElementById("list").innerHTML =
  "<ul>" + clientes.map(c => `<li>${c.nombre} – ${c.email}</li>`).join("") + "</ul>";

function generar(){
  let linksHTML = "";
  let enviados = 0;

  clientes.forEach(c => {

    let url = `https://alevanteastriperg-commits.github.io/Proyecto-Final/votar.html?email=${encodeURIComponent(c.email)}`;

    linksHTML += `<p>${c.email} — <a href="${url}" target="_blank">Abrir</a></p>`;

    emailjs.send(SERVICE_ID, TEMPLATE_ID, {
      nombre: c.nombre,
      email: c.email,
      link: url
    })
    .then(() => {
      enviados++;
      document.getElementById("msg").innerHTML = "✔ Correos enviados: " + enviados;
    })
    .catch(err => {
      console.error(err);
      document.getElementById("msg").innerHTML = "❌ Error enviando algunos correos.";
    });
  });

  document.getElementById("links").innerHTML = linksHTML;
}
</script>

</body>
</html>


